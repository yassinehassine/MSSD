<div class="d-sm-flex align-items-center justify-content-between mb-4">
  <h1 class="h3 mb-0 text-gray-800">
    {{ isEditing ? 'Edit Blog' : 'Create New Blog' }}
  </h1>
  <a routerLink="/admin/blog" class="d-none d-sm-inline-block btn btn-sm btn-secondary shadow-sm">
    <i class="fas fa-arrow-left fa-sm text-white-50"></i> Back to Blog List
  </a>
</div>

<div *ngIf="isLoading" class="text-center py-4">
  <div class="spinner-border" role="status">
    <span class="sr-only">Loading...</span>
  </div>
</div>

<form *ngIf="!isLoading" (ngSubmit)="onSubmit()" #blogForm="ngForm">
  <div class="row">
    <!-- Main Content Column -->
    <div class="col-md-8">
      <!-- Basic Information -->
      <div class="card shadow mb-4">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-primary">Basic Information</h6>
        </div>
        <div class="card-body">
          <!-- Title -->
          <div class="form-group">
            <label for="title">Title *</label>
            <input
              type="text"
              class="form-control"
              [class.is-invalid]="hasFieldError('title')"
              id="title"
              name="title"
              [(ngModel)]="blog.title"
              (input)="onTitleChange()"
              placeholder="Enter blog title"
              required
            >
            <div *ngIf="hasFieldError('title')" class="invalid-feedback">
              {{ getFieldError('title') }}
            </div>
          </div>

          <!-- Slug -->
          <div class="form-group">
            <label for="slug">Slug *</label>
            <div class="input-group">
              <input
                type="text"
                class="form-control"
                [class.is-invalid]="hasFieldError('slug')"
                id="slug"
                name="slug"
                [(ngModel)]="blog.slug"
                (input)="onSlugChange()"
                placeholder="url-friendly-version"
                required
              >
              <div class="input-group-append" *ngIf="slugCheckInProgress">
                <span class="input-group-text">
                  <div class="spinner-border spinner-border-sm" role="status"></div>
                </span>
              </div>
              <div class="input-group-append" *ngIf="!slugCheckInProgress && blog.slug && isSlugAvailable">
                <span class="input-group-text text-success">
                  <i class="fas fa-check"></i>
                </span>
              </div>
              <div class="input-group-append" *ngIf="!slugCheckInProgress && blog.slug && !isSlugAvailable">
                <span class="input-group-text text-danger">
                  <i class="fas fa-times"></i>
                </span>
              </div>
            </div>
            <div *ngIf="hasFieldError('slug')" class="invalid-feedback d-block">
              {{ getFieldError('slug') }}
            </div>
            <small class="form-text text-muted">URL-friendly version of the title</small>
          </div>

          <!-- Excerpt -->
          <div class="form-group">
            <label for="excerpt">Excerpt</label>
            <textarea
              class="form-control"
              id="excerpt"
              name="excerpt"
              [(ngModel)]="blog.excerpt"
              rows="3"
              placeholder="Brief description of the blog post (auto-generated if left empty)"
            ></textarea>
            <small class="form-text text-muted">Brief description (auto-generated from content if left empty)</small>
          </div>

          <!-- Content -->
          <div class="form-group">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <label for="content">Content *</label>
              <div class="btn-group btn-group-sm" role="group">
                <button type="button" class="btn btn-outline-secondary" (click)="insertMarkdown('bold')" title="Bold">
                  <i class="fas fa-bold"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary" (click)="insertMarkdown('italic')" title="Italic">
                  <i class="fas fa-italic"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary" (click)="insertMarkdown('h1')" title="Heading 1">
                  H1
                </button>
                <button type="button" class="btn btn-outline-secondary" (click)="insertMarkdown('h2')" title="Heading 2">
                  H2
                </button>
                <button type="button" class="btn btn-outline-secondary" (click)="insertMarkdown('link')" title="Link">
                  <i class="fas fa-link"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary" (click)="insertMarkdown('image')" title="Image">
                  <i class="fas fa-image"></i>
                </button>
                <button type="button" class="btn btn-outline-info" (click)="toggleContentPreview()">
                  {{ showContentPreview ? 'Edit' : 'Preview' }}
                </button>
              </div>
            </div>
            
            <textarea
              *ngIf="!showContentPreview"
              class="form-control"
              [class.is-invalid]="hasFieldError('content')"
              id="content"
              name="content"
              [(ngModel)]="blog.content"
              (input)="onContentChange()"
              rows="15"
              placeholder="Write your blog content here... (Markdown supported)"
              required
            ></textarea>
            
            <div 
              *ngIf="showContentPreview"
              class="card"
              style="min-height: 300px; padding: 15px;"
              [innerHTML]="blog.content"
            ></div>
            
            <div *ngIf="hasFieldError('content')" class="invalid-feedback">
              {{ getFieldError('content') }}
            </div>
            <small class="form-text text-muted">Markdown formatting is supported</small>
          </div>
        </div>
      </div>
    </div>

    <!-- Sidebar Column -->
    <div class="col-md-4">
      <!-- Publish Settings -->
      <div class="card shadow mb-4">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-primary">Publish Settings</h6>
        </div>
        <div class="card-body">
          <div class="form-check">
            <input
              class="form-check-input"
              type="checkbox"
              id="published"
              name="published"
              [(ngModel)]="blog.published"
            >
            <label class="form-check-label" for="published">
              Publish immediately
            </label>
          </div>
          <small class="form-text text-muted">
            Unchecked posts are saved as drafts
          </small>
        </div>
      </div>

      <!-- Metadata -->
      <div class="card shadow mb-4">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-primary">Metadata</h6>
        </div>
        <div class="card-body">
          <!-- Author -->
          <div class="form-group">
            <label for="author">Author</label>
            <input
              type="text"
              class="form-control"
              id="author"
              name="author"
              [(ngModel)]="blog.author"
              placeholder="Author name"
              list="authorsList"
            >
            <datalist id="authorsList">
              <option *ngFor="let author of authors" [value]="author">
            </datalist>
          </div>

          <!-- Category -->
          <div class="form-group">
            <label for="category">Category</label>
            <input
              type="text"
              class="form-control"
              id="category"
              name="category"
              [(ngModel)]="blog.category"
              placeholder="Category"
              list="categoriesList"
            >
            <datalist id="categoriesList">
              <option *ngFor="let category of categories" [value]="category">
            </datalist>
          </div>

          <!-- Tags -->
          <div class="form-group">
            <label for="tags">Tags</label>
            <input
              type="text"
              class="form-control"
              id="tags"
              name="tags"
              [(ngModel)]="blog.tags"
              placeholder="tag1, tag2, tag3"
            >
            <small class="form-text text-muted">Comma-separated tags</small>
          </div>
        </div>
      </div>

      <!-- Featured Image -->
      <div class="card shadow mb-4">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-primary">Featured Image</h6>
        </div>
        <div class="card-body">
          <!-- Image Preview -->
          <div *ngIf="imagePreview" class="mb-3">
            <img [src]="imagePreview" alt="Preview" class="img-fluid rounded">
            <button type="button" class="btn btn-sm btn-outline-danger mt-2" (click)="removeImage()">
              <i class="fas fa-trash"></i> Remove Image
            </button>
          </div>

          <!-- Upload Section -->
          <div class="mb-3">
            <label for="imageFile" class="form-label">Upload New Image</label>
            <input
              type="file"
              class="form-control"
              id="imageFile"
              accept="image/*"
              (change)="onFileSelected($event)"
            >
            <button 
              *ngIf="selectedFile && !isUploading" 
              type="button" 
              class="btn btn-sm btn-primary mt-2"
              (click)="uploadImage()"
            >
              <i class="fas fa-upload"></i> Upload
            </button>
            <button 
              *ngIf="isUploading" 
              type="button" 
              class="btn btn-sm btn-primary mt-2" 
              disabled
            >
              <span class="spinner-border spinner-border-sm" role="status"></span>
              Uploading...
            </button>
          </div>

          <!-- Image Library -->
          <div class="mb-3">
            <button 
              type="button" 
              class="btn btn-sm btn-outline-info"
              (click)="showImageLibrary = !showImageLibrary"
            >
              <i class="fas fa-images"></i> Choose from Library
            </button>
          </div>

          <!-- Image Library Modal -->
          <div *ngIf="showImageLibrary" class="mt-3">
            <div class="row">
              <div 
                *ngFor="let image of availableImages" 
                class="col-6 col-md-4 mb-2"
              >
                <img 
                  [src]="blogServicePublic.getImageUrl(image.filename || image.url)" 
                  [alt]="image.filename"
                  class="img-fluid rounded cursor-pointer"
                  style="height: 60px; object-fit: cover; width: 100%;"
                  (click)="selectFromLibrary(image)"
                >
              </div>
            </div>
          </div>

          <!-- Direct URL -->
          <div class="form-group">
            <label for="imageUrl">Or enter image URL</label>
            <input
              type="url"
              class="form-control"
              id="imageUrl"
              name="imageUrl"
              [(ngModel)]="blog.imageUrl"
              placeholder="https://example.com/image.jpg"
            >
          </div>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="card shadow mb-4">
        <div class="card-body">
          <div class="d-grid gap-2">
            <button 
              type="submit" 
              class="btn btn-primary"
              [disabled]="!isFormValid() || isSaving"
            >
              <span *ngIf="isSaving" class="spinner-border spinner-border-sm me-2" role="status"></span>
              {{ isEditing ? 'Update Blog' : 'Create Blog' }}
            </button>
            <button type="button" class="btn btn-secondary" (click)="cancel()">
              Cancel
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</form>